#!/bin/bash

source "$OPENSHIFT_HOMEDIR/openshift-nginx-multinode/bin/util"

function nohup_starter(){
    nohup supervisor "$OPENSHIFT_REPO_DIR/$1" > "$OPENSHIFT_LOG_DIR/nodejs.log" 2>&1 &
    echo "$!" > "$OPENSHIFT_DATA_DIR/server$2.pid"
}

function build(){
    install_node_app
}

function start(){
    echo "Starting"
    nohup "$OPENSHIFT_NGINX_DIR/sbin/nginx" > "$OPENSHIFT_LOG_DIR/nohup_nginx.out" 2>&1 &
    
    i=0
    server_registry="$OPENSHIFT_REPO_DIR/server_registry"
    while IFS= read -r server
    do
	nohup_starter "$server" "$i"
	i=$((i+1))
    done < "$server_registry"
}

function stop(){
    echo "stopping"
    "$OPENSHIFT_NGINX_DIR/sbin/nginx" -s stop
    for server_pid in "$OPENSHIFT_DATA_DIR"/server*.pid
    do
	head -n 1 "$server_pid" | xargs kill
	rm "$server_pid"
    done
}

function restart(){
    echo "restarting"
}

case ${1} in
  #pre-repo-archive) pre-repo-archive ;;
    #pre-build)        pre_build        ;;
    build)            build            ;;
    start)            start            ;;
    stop)             stop             ;;
    restart)          restart          ;;
    #status)           status           ;;
    #tidy)             tidy             ;;
    *)                exit 0
esac


