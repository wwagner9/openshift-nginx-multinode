#!/bin/bash

exec >> "$OPENSHIFT_NGINJS_DIR/control_log" 2>&1

source "$OPENSHIFT_HOMEDIR/openshift-nginx-multinode/bin/util"

function nohup_starter(){

    log "Starting $1 with id $2"

    nohup "$OPENSHIFT_NODE_BIN" "$OPENSHIFT_SUPERVISOR_BIN" -w "$OPENSHIFT_REPO_DIR" -x "$OPENSHIFT_NODE_BIN" -pid "$OPENSHIFT_DATA_DIR/server$2.pid" "$OPENSHIFT_REPO_DIR/$1" > "$OPENSHIFT_LOG_DIR/nodejs$2.log" 2>&1 &

}

function build(){
    install_node_app
}

function start(){
    log "Starting"

    nohup "$OPENSHIFT_NGINX_DIR/sbin/nginx" > "$OPENSHIFT_LOG_DIR/nohup_nginx.out" 2>&1 &
    
    i=0
    server_registry="$OPENSHIFT_REPO_DIR/server_registry"
    while IFS= read -r server
    do

	nohup_starter "$server" "$i"
	i=$((i+1))
    done < "$server_registry"
}

function stop(){
    log "stopping"
    
    "$OPENSHIFT_NGINX_DIR/sbin/nginx" -s stop

    for server_pid in $(find "$OPENSHIFT_DATA_DIR" -name "server*.pid" -type f)
    do
	log "Killing $server_pid $(head -n 1 '$server_pid')"
        head -n 1 "$server_pid" | xargs kill
        rm "$server_pid"
    done
}

function restart(){
    log "restarting"
}

case ${1} in
  #pre-repo-archive) pre-repo-archive ;;
    #pre-build)        pre_build        ;;
    build)            build            ;;
    start)            start            ;;
    stop)             stop             ;;
    restart)          restart          ;;
    #status)           status           ;;
    #tidy)             tidy             ;;
    *)                exit 0
esac


