#!/bin/bash

source "$OPENSHIFT_HOMEDIR"/nginx-node-pm2-issuetracker/bin/util

function nohup_starter(){
    nohup supervisor "$OPENSHIFT_REPO_DIR"/$1 > "$OPENSHIFT_LOG_DIR"/nodejs.log 2>&1 &
}

function build(){
    install_node_app
}

function start(){
    echo "Starting"
    nohup "$OPENSHIFT_NGINX_DIR/sbin/nginx" &
    export -f nohup_starter
    cat "$OPENSHIFT_REPO_DIR"/server_registry | xargs -L 1 -I {} bash -c 'nohup_starter "$@"' _ {}
}

function stop(){
    echo "stopping"
    "$OPENSHIFT_NGINX_DIR/sbin/nginx -c stop"
}

function restart(){
    echo "restarting"
}

case ${1} in
  #pre-repo-archive) pre-repo-archive ;;
    #pre-build)        pre_build        ;;
    build)            build            ;;
    start)            start            ;;
    stop)             stop             ;;
    restart)          restart          ;;
    #status)           status           ;;
    #tidy)             tidy             ;;
    *)                exit 0
esac


